<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/Development/Shake/FilePattern.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE PatternGuards, ViewPatterns #-}</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Development</span><span class='hs-varop'>.</span><span class='hs-conid'>Shake</span><span class='hs-varop'>.</span><span class='hs-conid'>FilePattern</span><span class='hs-layout'>(</span>
<a name="line-4"></a>    <span class='hs-comment'>-- * Primitive API, as exposed</span>
<a name="line-5"></a>    <span class='hs-conid'>FilePattern</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varop'>?==</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varop'>&lt;//&gt;</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-6"></a>    <span class='hs-comment'>-- * Optimisation opportunities</span>
<a name="line-7"></a>    <span class='hs-varid'>simple</span><span class='hs-layout'>,</span>
<a name="line-8"></a>    <span class='hs-comment'>-- * Multipattern file rules</span>
<a name="line-9"></a>    <span class='hs-varid'>compatible</span><span class='hs-layout'>,</span> <span class='hs-varid'>extract</span><span class='hs-layout'>,</span> <span class='hs-varid'>substitute</span><span class='hs-layout'>,</span>
<a name="line-10"></a>    <span class='hs-comment'>-- * Accelerated searching</span>
<a name="line-11"></a>    <span class='hs-conid'>Walk</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>walk</span><span class='hs-layout'>,</span>
<a name="line-12"></a>    <span class='hs-comment'>-- * Testing only</span>
<a name="line-13"></a>    <span class='hs-varid'>internalTest</span><span class='hs-layout'>,</span> <span class='hs-varid'>isRelativePath</span><span class='hs-layout'>,</span> <span class='hs-varid'>isRelativePattern</span>
<a name="line-14"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-15"></a>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Development</span><span class='hs-varop'>.</span><span class='hs-conid'>Shake</span><span class='hs-varop'>.</span><span class='hs-conid'>Errors</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>FilePath</span><span class='hs-layout'>(</span><span class='hs-varid'>isPathSeparator</span><span class='hs-layout'>)</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span><span class='hs-varop'>.</span><span class='hs-conid'>Extra</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Applicative</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Char</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Tuple</span><span class='hs-varop'>.</span><span class='hs-conid'>Extra</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Maybe</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Info</span><span class='hs-varop'>.</span><span class='hs-conid'>Extra</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Prelude</span>
<a name="line-26"></a>
<a name="line-27"></a>
<a name="line-28"></a><a name="FilePattern"></a><span class='hs-comment'>-- | A type synonym for file patterns, containing @\/\/@ and @*@. For the syntax</span>
<a name="line-29"></a><a name="FilePattern"></a><span class='hs-comment'>--   and semantics of 'FilePattern' see '?=='.</span>
<a name="line-30"></a><a name="FilePattern"></a><span class='hs-comment'>--</span>
<a name="line-31"></a><a name="FilePattern"></a><span class='hs-comment'>--   Most 'normaliseEx'd 'FilePath' values are suitable as 'FilePattern' values which match</span>
<a name="line-32"></a><a name="FilePattern"></a><span class='hs-comment'>--   only that specific file. On Windows @\\@ is treated as equivalent to @\/@.</span>
<a name="line-33"></a><a name="FilePattern"></a><span class='hs-comment'>--</span>
<a name="line-34"></a><a name="FilePattern"></a><span class='hs-comment'>--   You can write 'FilePattern' values as a literal string, or build them</span>
<a name="line-35"></a><a name="FilePattern"></a><span class='hs-comment'>--   up using the operators 'Development.Shake.FilePath.&lt;.&gt;', 'Development.Shake.FilePath.&lt;/&gt;'</span>
<a name="line-36"></a><a name="FilePattern"></a><span class='hs-comment'>--   and 'Development.Shake.&lt;//&gt;'. However, beware that:</span>
<a name="line-37"></a><a name="FilePattern"></a><span class='hs-comment'>--</span>
<a name="line-38"></a><a name="FilePattern"></a><span class='hs-comment'>-- * On Windows, use 'Development.Shake.FilePath.&lt;.&gt;' from "Development.Shake.FilePath" instead of from</span>
<a name="line-39"></a><a name="FilePattern"></a><span class='hs-comment'>--   "System.FilePath" - otherwise @\"\/\/*\" \&lt;.\&gt; exe@ results in @\"\/\/*\\\\.exe\"@.</span>
<a name="line-40"></a><a name="FilePattern"></a><span class='hs-comment'>--</span>
<a name="line-41"></a><a name="FilePattern"></a><span class='hs-comment'>-- * If the second argument of 'Development.Shake.FilePath.&lt;/&gt;' has a leading path separator (namely @\/@)</span>
<a name="line-42"></a><a name="FilePattern"></a><span class='hs-comment'>--   then the second argument will be returned.</span>
<a name="line-43"></a><a name="FilePattern"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>FilePattern</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>String</span>
<a name="line-44"></a>
<a name="line-45"></a><span class='hs-keyword'>infixr</span> <span class='hs-num'>5</span> <span class='hs-varop'>&lt;//&gt;</span>
<a name="line-46"></a>
<a name="line-47"></a><a name="%3c//%3e"></a><span class='hs-comment'>-- | Join two 'FilePattern' values by inserting two @\/@ characters between them.</span>
<a name="line-48"></a><span class='hs-comment'>--   Will first remove any trailing path separators on the first argument, and any leading</span>
<a name="line-49"></a><span class='hs-comment'>--   separators on the second.</span>
<a name="line-50"></a><span class='hs-comment'>--</span>
<a name="line-51"></a><span class='hs-comment'>-- &gt; "dir" &lt;//&gt; "*" == "dir//*"</span>
<a name="line-52"></a><span class='hs-layout'>(</span><span class='hs-varop'>&lt;//&gt;</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePattern</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePattern</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePattern</span>
<a name="line-53"></a><a name="a"></a><span class='hs-definition'>a</span> <span class='hs-varop'>&lt;//&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dropWhileEnd</span> <span class='hs-varid'>isPathSeparator</span> <span class='hs-varid'>a</span> <span class='hs-varop'>++</span> <span class='hs-str'>"//"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>dropWhile</span> <span class='hs-varid'>isPathSeparator</span> <span class='hs-varid'>b</span>
<a name="line-54"></a>
<a name="line-55"></a>
<a name="line-56"></a><span class='hs-comment'>---------------------------------------------------------------------</span>
<a name="line-57"></a><span class='hs-comment'>-- PATTERNS</span>
<a name="line-58"></a>
<a name="line-59"></a><a name="Pat"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Pat</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Lit</span> <span class='hs-conid'>String</span> <span class='hs-comment'>-- ^ foo</span>
<a name="line-60"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Star</span>   <span class='hs-comment'>-- ^ /*/</span>
<a name="line-61"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Skip</span> <span class='hs-comment'>-- ^ //</span>
<a name="line-62"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Skip1</span> <span class='hs-comment'>-- ^ //, but must be at least 1 element</span>
<a name="line-63"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Stars</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span> <span class='hs-conid'>String</span> <span class='hs-comment'>-- ^ *foo*, prefix (fixed), infix floaters, suffix</span>
<a name="line-64"></a>                                        <span class='hs-comment'>-- e.g. *foo*bar = Stars "" ["foo"] "bar"</span>
<a name="line-65"></a>            <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Show</span><span class='hs-layout'>,</span><span class='hs-conid'>Eq</span><span class='hs-layout'>,</span><span class='hs-conid'>Ord</span><span class='hs-layout'>)</span>
<a name="line-66"></a>
<a name="line-67"></a><a name="isLit"></a><span class='hs-definition'>isLit</span> <span class='hs-conid'>Lit</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span><span class='hs-layout'>;</span> <span class='hs-varid'>isLit</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-68"></a><a name="fromLit"></a><span class='hs-definition'>fromLit</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lit</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span>
<a name="line-69"></a>
<a name="line-70"></a>
<a name="line-71"></a><a name="Lexeme"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Lexeme</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Str</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Slash</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SlashSlash</span>
<a name="line-72"></a>
<a name="line-73"></a><a name="lexer"></a><span class='hs-definition'>lexer</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePattern</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Lexeme</span><span class='hs-keyglyph'>]</span>
<a name="line-74"></a><span class='hs-definition'>lexer</span> <span class='hs-str'>""</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-75"></a><span class='hs-definition'>lexer</span> <span class='hs-layout'>(</span><span class='hs-varid'>x1</span><span class='hs-conop'>:</span><span class='hs-varid'>x2</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isPathSeparator</span> <span class='hs-varid'>x1</span><span class='hs-layout'>,</span> <span class='hs-varid'>isPathSeparator</span> <span class='hs-varid'>x2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SlashSlash</span> <span class='hs-conop'>:</span> <span class='hs-varid'>lexer</span> <span class='hs-varid'>xs</span>
<a name="line-76"></a><span class='hs-definition'>lexer</span> <span class='hs-layout'>(</span><span class='hs-varid'>x1</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isPathSeparator</span> <span class='hs-varid'>x1</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Slash</span> <span class='hs-conop'>:</span> <span class='hs-varid'>lexer</span> <span class='hs-varid'>xs</span>
<a name="line-77"></a><span class='hs-definition'>lexer</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Str</span> <span class='hs-varid'>a</span> <span class='hs-conop'>:</span> <span class='hs-varid'>lexer</span> <span class='hs-varid'>b</span>
<a name="line-78"></a>    <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>break</span> <span class='hs-varid'>isPathSeparator</span> <span class='hs-varid'>xs</span>
<a name="line-79"></a>
<a name="line-80"></a>
<a name="line-81"></a><a name="parse"></a><span class='hs-comment'>-- | Parse a FilePattern. All optimisations I can think of are invalid because they change the extracted expressions.</span>
<a name="line-82"></a><span class='hs-definition'>parse</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePattern</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Pat</span><span class='hs-keyglyph'>]</span>
<a name="line-83"></a><span class='hs-definition'>parse</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-conid'>False</span> <span class='hs-conid'>True</span> <span class='hs-varop'>.</span> <span class='hs-varid'>lexer</span>
<a name="line-84"></a>    <span class='hs-keyword'>where</span>
<a name="line-85"></a>        <span class='hs-comment'>-- str = I have ever seen a Str go past (equivalent to "can I be satisfied by no paths")</span>
<a name="line-86"></a>        <span class='hs-comment'>-- slash = I am either at the start, or my previous character was Slash</span>
<a name="line-87"></a>        <span class='hs-varid'>f</span> <span class='hs-varid'>str</span> <span class='hs-varid'>slash</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Lit</span> <span class='hs-str'>""</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>slash</span><span class='hs-keyglyph'>]</span>
<a name="line-88"></a>        <span class='hs-varid'>f</span> <span class='hs-varid'>str</span> <span class='hs-varid'>slash</span> <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-str'>"**"</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Skip</span> <span class='hs-conop'>:</span> <span class='hs-varid'>f</span> <span class='hs-conid'>True</span> <span class='hs-conid'>False</span> <span class='hs-varid'>xs</span>
<a name="line-89"></a>        <span class='hs-varid'>f</span> <span class='hs-varid'>str</span> <span class='hs-varid'>slash</span> <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parseLit</span> <span class='hs-varid'>x</span> <span class='hs-conop'>:</span> <span class='hs-varid'>f</span> <span class='hs-conid'>True</span> <span class='hs-conid'>False</span> <span class='hs-varid'>xs</span>
<a name="line-90"></a>        <span class='hs-varid'>f</span> <span class='hs-varid'>str</span> <span class='hs-varid'>slash</span> <span class='hs-layout'>(</span><span class='hs-conid'>SlashSlash</span><span class='hs-conop'>:</span><span class='hs-conid'>Slash</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Skip1</span> <span class='hs-conop'>:</span> <span class='hs-varid'>f</span> <span class='hs-varid'>str</span> <span class='hs-conid'>True</span> <span class='hs-varid'>xs</span>
<a name="line-91"></a>        <span class='hs-varid'>f</span> <span class='hs-varid'>str</span> <span class='hs-varid'>slash</span> <span class='hs-layout'>(</span><span class='hs-conid'>SlashSlash</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Skip</span> <span class='hs-conop'>:</span> <span class='hs-varid'>f</span> <span class='hs-varid'>str</span> <span class='hs-conid'>False</span> <span class='hs-varid'>xs</span>
<a name="line-92"></a>        <span class='hs-varid'>f</span> <span class='hs-varid'>str</span> <span class='hs-varid'>slash</span> <span class='hs-layout'>(</span><span class='hs-conid'>Slash</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Lit</span> <span class='hs-str'>""</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>str</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>++</span> <span class='hs-varid'>f</span> <span class='hs-varid'>str</span> <span class='hs-conid'>True</span> <span class='hs-varid'>xs</span>
<a name="line-93"></a>
<a name="line-94"></a>
<a name="line-95"></a><a name="parseLit"></a><span class='hs-definition'>parseLit</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Pat</span>
<a name="line-96"></a><span class='hs-definition'>parseLit</span> <span class='hs-str'>"*"</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Star</span>
<a name="line-97"></a><span class='hs-definition'>parseLit</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>split</span> <span class='hs-layout'>(</span><span class='hs-varop'>==</span> <span class='hs-chr'>'*'</span><span class='hs-layout'>)</span> <span class='hs-varid'>x</span> <span class='hs-keyword'>of</span>
<a name="line-98"></a>    <span class='hs-keyglyph'>[</span><span class='hs-varid'>x</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Lit</span> <span class='hs-varid'>x</span>
<a name="line-99"></a>    <span class='hs-varid'>pre</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>mid</span><span class='hs-layout'>,</span><span class='hs-varid'>post</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unsnoc</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Stars</span> <span class='hs-varid'>pre</span> <span class='hs-varid'>mid</span> <span class='hs-varid'>post</span>
<a name="line-100"></a>
<a name="line-101"></a>
<a name="line-102"></a><a name="internalTest"></a><span class='hs-definition'>internalTest</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-103"></a><span class='hs-definition'>internalTest</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-104"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>x</span> <span class='hs-cpp'>#</span> <span class='hs-varid'>y</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>parse</span> <span class='hs-varid'>x</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>y</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fail</span> <span class='hs-varop'>$</span> <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-str'>"FilePattern.internalTest"</span><span class='hs-layout'>,</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span><span class='hs-varid'>parse</span> <span class='hs-varid'>x</span><span class='hs-layout'>,</span><span class='hs-varid'>y</span><span class='hs-layout'>)</span>
<a name="line-105"></a>    <span class='hs-str'>""</span> <span class='hs-cpp'>#</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Lit</span> <span class='hs-str'>""</span><span class='hs-keyglyph'>]</span>
<a name="line-106"></a>    <span class='hs-str'>"x"</span> <span class='hs-cpp'>#</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Lit</span> <span class='hs-str'>"x"</span><span class='hs-keyglyph'>]</span>
<a name="line-107"></a>    <span class='hs-str'>"/"</span> <span class='hs-cpp'>#</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Lit</span> <span class='hs-str'>""</span><span class='hs-layout'>,</span><span class='hs-conid'>Lit</span> <span class='hs-str'>""</span><span class='hs-keyglyph'>]</span>
<a name="line-108"></a>    <span class='hs-str'>"x/"</span> <span class='hs-cpp'>#</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Lit</span> <span class='hs-str'>"x"</span><span class='hs-layout'>,</span><span class='hs-conid'>Lit</span> <span class='hs-str'>""</span><span class='hs-keyglyph'>]</span>
<a name="line-109"></a>    <span class='hs-str'>"/x"</span> <span class='hs-cpp'>#</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Lit</span> <span class='hs-str'>""</span><span class='hs-layout'>,</span><span class='hs-conid'>Lit</span> <span class='hs-str'>"x"</span><span class='hs-keyglyph'>]</span>
<a name="line-110"></a>    <span class='hs-str'>"x/y"</span> <span class='hs-cpp'>#</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Lit</span> <span class='hs-str'>"x"</span><span class='hs-layout'>,</span><span class='hs-conid'>Lit</span> <span class='hs-str'>"y"</span><span class='hs-keyglyph'>]</span>
<a name="line-111"></a>    <span class='hs-str'>"//"</span> <span class='hs-cpp'>#</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Skip</span><span class='hs-keyglyph'>]</span>
<a name="line-112"></a>    <span class='hs-str'>"**"</span> <span class='hs-cpp'>#</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Skip</span><span class='hs-keyglyph'>]</span>
<a name="line-113"></a>    <span class='hs-str'>"//x"</span> <span class='hs-cpp'>#</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Skip</span><span class='hs-layout'>,</span> <span class='hs-conid'>Lit</span> <span class='hs-str'>"x"</span><span class='hs-keyglyph'>]</span>
<a name="line-114"></a>    <span class='hs-str'>"**/x"</span> <span class='hs-cpp'>#</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Skip</span><span class='hs-layout'>,</span> <span class='hs-conid'>Lit</span> <span class='hs-str'>"x"</span><span class='hs-keyglyph'>]</span>
<a name="line-115"></a>    <span class='hs-str'>"x//"</span> <span class='hs-cpp'>#</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Lit</span> <span class='hs-str'>"x"</span><span class='hs-layout'>,</span> <span class='hs-conid'>Skip</span><span class='hs-keyglyph'>]</span>
<a name="line-116"></a>    <span class='hs-str'>"x/**"</span> <span class='hs-cpp'>#</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Lit</span> <span class='hs-str'>"x"</span><span class='hs-layout'>,</span> <span class='hs-conid'>Skip</span><span class='hs-keyglyph'>]</span>
<a name="line-117"></a>    <span class='hs-str'>"x//y"</span> <span class='hs-cpp'>#</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Lit</span> <span class='hs-str'>"x"</span><span class='hs-layout'>,</span><span class='hs-conid'>Skip</span><span class='hs-layout'>,</span> <span class='hs-conid'>Lit</span> <span class='hs-str'>"y"</span><span class='hs-keyglyph'>]</span>
<a name="line-118"></a>    <span class='hs-str'>"x/**/y"</span> <span class='hs-cpp'>#</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Lit</span> <span class='hs-str'>"x"</span><span class='hs-layout'>,</span><span class='hs-conid'>Skip</span><span class='hs-layout'>,</span> <span class='hs-conid'>Lit</span> <span class='hs-str'>"y"</span><span class='hs-keyglyph'>]</span>
<a name="line-119"></a>    <span class='hs-str'>"///"</span> <span class='hs-cpp'>#</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Skip1</span><span class='hs-layout'>,</span> <span class='hs-conid'>Lit</span> <span class='hs-str'>""</span><span class='hs-keyglyph'>]</span>
<a name="line-120"></a>    <span class='hs-str'>"**/**"</span> <span class='hs-cpp'>#</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Skip</span><span class='hs-layout'>,</span><span class='hs-conid'>Skip</span><span class='hs-keyglyph'>]</span>
<a name="line-121"></a>    <span class='hs-str'>"**/**/"</span> <span class='hs-cpp'>#</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Skip</span><span class='hs-layout'>,</span> <span class='hs-conid'>Skip</span><span class='hs-layout'>,</span> <span class='hs-conid'>Lit</span> <span class='hs-str'>""</span><span class='hs-keyglyph'>]</span>
<a name="line-122"></a>    <span class='hs-str'>"///x"</span> <span class='hs-cpp'>#</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Skip1</span><span class='hs-layout'>,</span> <span class='hs-conid'>Lit</span> <span class='hs-str'>"x"</span><span class='hs-keyglyph'>]</span>
<a name="line-123"></a>    <span class='hs-str'>"**/x"</span> <span class='hs-cpp'>#</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Skip</span><span class='hs-layout'>,</span> <span class='hs-conid'>Lit</span> <span class='hs-str'>"x"</span><span class='hs-keyglyph'>]</span>
<a name="line-124"></a>    <span class='hs-str'>"x///"</span> <span class='hs-cpp'>#</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Lit</span> <span class='hs-str'>"x"</span><span class='hs-layout'>,</span> <span class='hs-conid'>Skip</span><span class='hs-layout'>,</span> <span class='hs-conid'>Lit</span> <span class='hs-str'>""</span><span class='hs-keyglyph'>]</span>
<a name="line-125"></a>    <span class='hs-str'>"x/**/"</span> <span class='hs-cpp'>#</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Lit</span> <span class='hs-str'>"x"</span><span class='hs-layout'>,</span> <span class='hs-conid'>Skip</span><span class='hs-layout'>,</span> <span class='hs-conid'>Lit</span> <span class='hs-str'>""</span><span class='hs-keyglyph'>]</span>
<a name="line-126"></a>    <span class='hs-str'>"x///y"</span> <span class='hs-cpp'>#</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Lit</span> <span class='hs-str'>"x"</span><span class='hs-layout'>,</span><span class='hs-conid'>Skip</span><span class='hs-layout'>,</span> <span class='hs-conid'>Lit</span> <span class='hs-str'>"y"</span><span class='hs-keyglyph'>]</span>
<a name="line-127"></a>    <span class='hs-str'>"x/**/y"</span> <span class='hs-cpp'>#</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Lit</span> <span class='hs-str'>"x"</span><span class='hs-layout'>,</span><span class='hs-conid'>Skip</span><span class='hs-layout'>,</span> <span class='hs-conid'>Lit</span> <span class='hs-str'>"y"</span><span class='hs-keyglyph'>]</span>
<a name="line-128"></a>    <span class='hs-str'>"////"</span> <span class='hs-cpp'>#</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Skip</span><span class='hs-layout'>,</span> <span class='hs-conid'>Skip</span><span class='hs-keyglyph'>]</span>
<a name="line-129"></a>    <span class='hs-str'>"**/**/**"</span> <span class='hs-cpp'>#</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Skip</span><span class='hs-layout'>,</span> <span class='hs-conid'>Skip</span><span class='hs-layout'>,</span> <span class='hs-conid'>Skip</span><span class='hs-keyglyph'>]</span>
<a name="line-130"></a>    <span class='hs-str'>"////x"</span> <span class='hs-cpp'>#</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Skip</span><span class='hs-layout'>,</span> <span class='hs-conid'>Skip</span><span class='hs-layout'>,</span> <span class='hs-conid'>Lit</span> <span class='hs-str'>"x"</span><span class='hs-keyglyph'>]</span>
<a name="line-131"></a>    <span class='hs-str'>"x////"</span> <span class='hs-cpp'>#</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Lit</span> <span class='hs-str'>"x"</span><span class='hs-layout'>,</span> <span class='hs-conid'>Skip</span><span class='hs-layout'>,</span> <span class='hs-conid'>Skip</span><span class='hs-keyglyph'>]</span>
<a name="line-132"></a>    <span class='hs-str'>"x////y"</span> <span class='hs-cpp'>#</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Lit</span> <span class='hs-str'>"x"</span><span class='hs-layout'>,</span><span class='hs-conid'>Skip</span><span class='hs-layout'>,</span> <span class='hs-conid'>Skip</span><span class='hs-layout'>,</span> <span class='hs-conid'>Lit</span> <span class='hs-str'>"y"</span><span class='hs-keyglyph'>]</span>
<a name="line-133"></a>    <span class='hs-str'>"**//x"</span> <span class='hs-cpp'>#</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Skip</span><span class='hs-layout'>,</span> <span class='hs-conid'>Skip</span><span class='hs-layout'>,</span> <span class='hs-conid'>Lit</span> <span class='hs-str'>"x"</span><span class='hs-keyglyph'>]</span>
<a name="line-134"></a>
<a name="line-135"></a>
<a name="line-136"></a><a name="optimise"></a><span class='hs-comment'>-- | Optimisations that may change the matched expressions</span>
<a name="line-137"></a><span class='hs-definition'>optimise</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Pat</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Pat</span><span class='hs-keyglyph'>]</span>
<a name="line-138"></a><span class='hs-definition'>optimise</span> <span class='hs-layout'>(</span><span class='hs-conid'>Skip</span><span class='hs-conop'>:</span><span class='hs-conid'>Skip</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>optimise</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Skip</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span>
<a name="line-139"></a><span class='hs-definition'>optimise</span> <span class='hs-layout'>(</span><span class='hs-conid'>Skip</span><span class='hs-conop'>:</span><span class='hs-conid'>Star</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>optimise</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Skip1</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span>
<a name="line-140"></a><span class='hs-definition'>optimise</span> <span class='hs-layout'>(</span><span class='hs-conid'>Star</span><span class='hs-conop'>:</span><span class='hs-conid'>Skip</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>optimise</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Skip1</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span>
<a name="line-141"></a><span class='hs-definition'>optimise</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span> <span class='hs-conop'>:</span> <span class='hs-varid'>optimise</span> <span class='hs-varid'>xs</span>
<a name="line-142"></a><span class='hs-definition'>optimise</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span><span class='hs-conid'>[]</span>
<a name="line-143"></a>
<a name="line-144"></a>
<a name="line-145"></a><a name="isRelativePattern"></a><span class='hs-comment'>-- | A 'FilePattern' that will only match 'isRelativePath' values.</span>
<a name="line-146"></a><span class='hs-definition'>isRelativePattern</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePattern</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-147"></a><span class='hs-definition'>isRelativePattern</span> <span class='hs-layout'>(</span><span class='hs-chr'>'*'</span><span class='hs-conop'>:</span><span class='hs-chr'>'*'</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span>
<a name="line-148"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-149"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xs</span><span class='hs-layout'>,</span> <span class='hs-varid'>isPathSeparator</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-150"></a><span class='hs-definition'>isRelativePattern</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-151"></a>
<a name="line-152"></a><a name="isRelativePath"></a><span class='hs-comment'>-- | A non-absolute 'FilePath'.</span>
<a name="line-153"></a><span class='hs-definition'>isRelativePath</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-154"></a><span class='hs-definition'>isRelativePath</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isPathSeparator</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-155"></a><span class='hs-definition'>isRelativePath</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-chr'>':'</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isWindows</span><span class='hs-layout'>,</span> <span class='hs-varid'>isAlpha</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-156"></a><span class='hs-definition'>isRelativePath</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-157"></a>
<a name="line-158"></a>
<a name="line-159"></a><a name="match"></a><span class='hs-comment'>-- | Given a pattern, and a list of path components, return a list of all matches</span>
<a name="line-160"></a><span class='hs-comment'>--   (for each wildcard in order, what the wildcard matched).</span>
<a name="line-161"></a><span class='hs-definition'>match</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Pat</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-162"></a><span class='hs-definition'>match</span> <span class='hs-layout'>(</span><span class='hs-conid'>Skip</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-conop'>:</span><span class='hs-varid'>ys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-str'>""</span><span class='hs-conop'>:</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>match</span> <span class='hs-varid'>xs</span> <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-conop'>:</span><span class='hs-varid'>ys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-varid'>match</span> <span class='hs-layout'>(</span><span class='hs-conid'>Skip1</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-conop'>:</span><span class='hs-varid'>ys</span><span class='hs-layout'>)</span>
<a name="line-163"></a><span class='hs-definition'>match</span> <span class='hs-layout'>(</span><span class='hs-conid'>Skip1</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-conop'>:</span><span class='hs-varid'>ys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-varop'>++</span><span class='hs-str'>"/"</span><span class='hs-varop'>++</span><span class='hs-varid'>r</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>rs</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>r</span><span class='hs-conop'>:</span><span class='hs-varid'>rs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>match</span> <span class='hs-layout'>(</span><span class='hs-conid'>Skip</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-varid'>ys</span><span class='hs-keyglyph'>]</span>
<a name="line-164"></a><span class='hs-definition'>match</span> <span class='hs-layout'>(</span><span class='hs-conid'>Skip</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-str'>""</span><span class='hs-conop'>:</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>match</span> <span class='hs-varid'>xs</span> <span class='hs-conid'>[]</span>
<a name="line-165"></a><span class='hs-definition'>match</span> <span class='hs-layout'>(</span><span class='hs-conid'>Star</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-conop'>:</span><span class='hs-varid'>ys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-conop'>:</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>match</span> <span class='hs-varid'>xs</span> <span class='hs-varid'>ys</span>
<a name="line-166"></a><span class='hs-definition'>match</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lit</span> <span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-conop'>:</span><span class='hs-varid'>ys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>x</span> <span class='hs-varop'>==</span> <span class='hs-varid'>y</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>match</span> <span class='hs-varid'>xs</span> <span class='hs-varid'>ys</span>
<a name="line-167"></a><span class='hs-definition'>match</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>Stars</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-conop'>:</span><span class='hs-varid'>ys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>rs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchStars</span> <span class='hs-varid'>x</span> <span class='hs-varid'>y</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>rs</span> <span class='hs-varop'>++</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>match</span> <span class='hs-varid'>xs</span> <span class='hs-varid'>ys</span>
<a name="line-168"></a><span class='hs-definition'>match</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>[]</span><span class='hs-keyglyph'>]</span>
<a name="line-169"></a><span class='hs-definition'>match</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-170"></a>
<a name="line-171"></a>
<a name="line-172"></a><a name="matchOne"></a><span class='hs-definition'>matchOne</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Pat</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-173"></a><span class='hs-definition'>matchOne</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lit</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-varid'>y</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span> <span class='hs-varop'>==</span> <span class='hs-varid'>y</span>
<a name="line-174"></a><span class='hs-definition'>matchOne</span> <span class='hs-varid'>x</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>Stars</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-varid'>y</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isJust</span> <span class='hs-varop'>$</span> <span class='hs-varid'>matchStars</span> <span class='hs-varid'>x</span> <span class='hs-varid'>y</span>
<a name="line-175"></a><span class='hs-definition'>matchOne</span> <span class='hs-conid'>Star</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-176"></a>
<a name="line-177"></a>
<a name="line-178"></a><a name="matchStars"></a><span class='hs-comment'>-- Only return the first (all patterns left-most) valid star matching</span>
<a name="line-179"></a><span class='hs-definition'>matchStars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Pat</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-180"></a><span class='hs-definition'>matchStars</span> <span class='hs-layout'>(</span><span class='hs-conid'>Stars</span> <span class='hs-varid'>pre</span> <span class='hs-varid'>mid</span> <span class='hs-varid'>post</span><span class='hs-layout'>)</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-181"></a>    <span class='hs-varid'>x</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stripPrefix</span> <span class='hs-varid'>pre</span> <span class='hs-varid'>x</span>
<a name="line-182"></a>    <span class='hs-varid'>x</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>post</span> <span class='hs-keyword'>then</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>x</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>stripSuffix</span> <span class='hs-varid'>post</span> <span class='hs-varid'>x</span>
<a name="line-183"></a>    <span class='hs-varid'>stripInfixes</span> <span class='hs-varid'>mid</span> <span class='hs-varid'>x</span>
<a name="line-184"></a>    <span class='hs-keyword'>where</span>
<a name="line-185"></a>        <span class='hs-varid'>stripInfixes</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>x</span><span class='hs-keyglyph'>]</span>
<a name="line-186"></a>        <span class='hs-varid'>stripInfixes</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-conop'>:</span><span class='hs-varid'>ms</span><span class='hs-layout'>)</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-187"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stripInfix</span> <span class='hs-varid'>m</span> <span class='hs-varid'>x</span>
<a name="line-188"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-conop'>:</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>stripInfixes</span> <span class='hs-varid'>ms</span> <span class='hs-varid'>x</span>
<a name="line-189"></a>
<a name="line-190"></a>
<a name="line-191"></a><a name="?=="></a><span class='hs-comment'>-- | Match a 'FilePattern' against a 'FilePath', There are three special forms:</span>
<a name="line-192"></a><span class='hs-comment'>--</span>
<a name="line-193"></a><span class='hs-comment'>-- * @*@ matches an entire path component, excluding any separators.</span>
<a name="line-194"></a><span class='hs-comment'>--</span>
<a name="line-195"></a><span class='hs-comment'>-- * @\/\/@ matches an arbitrary number of path components, including absolute path</span>
<a name="line-196"></a><span class='hs-comment'>--   prefixes.</span>
<a name="line-197"></a><span class='hs-comment'>--</span>
<a name="line-198"></a><span class='hs-comment'>-- * @**@ as a path component matches an arbitrary number of path components, but not</span>
<a name="line-199"></a><span class='hs-comment'>--   absolute path prefixes.</span>
<a name="line-200"></a><span class='hs-comment'>--   Currently considered experimental.</span>
<a name="line-201"></a><span class='hs-comment'>--</span>
<a name="line-202"></a><span class='hs-comment'>--   Some examples:</span>
<a name="line-203"></a><span class='hs-comment'>--</span>
<a name="line-204"></a><span class='hs-comment'>-- * @test.c@ matches @test.c@ and nothing else.</span>
<a name="line-205"></a><span class='hs-comment'>--</span>
<a name="line-206"></a><span class='hs-comment'>-- * @*.c@ matches all @.c@ files in the current directory, so @file.c@ matches,</span>
<a name="line-207"></a><span class='hs-comment'>--   but @file.h@ and @dir\/file.c@ don't.</span>
<a name="line-208"></a><span class='hs-comment'>--</span>
<a name="line-209"></a><span class='hs-comment'>-- * @\/\/*.c@ matches all @.c@ files anywhere on the filesystem,</span>
<a name="line-210"></a><span class='hs-comment'>--   so @file.c@, @dir\/file.c@, @dir1\/dir2\/file.c@ and @\/path\/to\/file.c@ all match,</span>
<a name="line-211"></a><span class='hs-comment'>--   but @file.h@ and @dir\/file.h@ don't.</span>
<a name="line-212"></a><span class='hs-comment'>--</span>
<a name="line-213"></a><span class='hs-comment'>-- * @dir\/*\/*@ matches all files one level below @dir@, so @dir\/one\/file.c@ and</span>
<a name="line-214"></a><span class='hs-comment'>--   @dir\/two\/file.h@ match, but @file.c@, @one\/dir\/file.c@, @dir\/file.h@</span>
<a name="line-215"></a><span class='hs-comment'>--   and @dir\/one\/two\/file.c@ don't.</span>
<a name="line-216"></a><span class='hs-comment'>--</span>
<a name="line-217"></a><span class='hs-comment'>--   Patterns with constructs such as @foo\/..\/bar@ will never match</span>
<a name="line-218"></a><span class='hs-comment'>--   normalised 'FilePath' values, so are unlikely to be correct.</span>
<a name="line-219"></a><span class='hs-layout'>(</span><span class='hs-varop'>?==</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePattern</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-220"></a><span class='hs-layout'>(</span><span class='hs-varop'>?==</span><span class='hs-layout'>)</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>optimise</span> <span class='hs-varop'>$</span> <span class='hs-varid'>parse</span> <span class='hs-varid'>p</span> <span class='hs-keyword'>of</span>
<a name="line-221"></a>    <span class='hs-keyglyph'>[</span><span class='hs-varid'>x</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>x</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Skip</span> <span class='hs-varop'>||</span> <span class='hs-varid'>x</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Skip1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>rp</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>isRelativePath</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>const</span> <span class='hs-conid'>True</span>
<a name="line-222"></a>    <span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>null</span> <span class='hs-varop'>.</span> <span class='hs-varid'>match</span> <span class='hs-varid'>p</span> <span class='hs-varop'>.</span> <span class='hs-varid'>split</span> <span class='hs-varid'>isPathSeparator</span>
<a name="line-223"></a>         <span class='hs-keyword'>in</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>rp</span> <span class='hs-keyword'>then</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isRelativePath</span> <span class='hs-varid'>x</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>f</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>f</span>
<a name="line-224"></a>    <span class='hs-keyword'>where</span> <span class='hs-varid'>rp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isRelativePattern</span> <span class='hs-varid'>p</span>
<a name="line-225"></a>
<a name="line-226"></a>
<a name="line-227"></a><span class='hs-comment'>---------------------------------------------------------------------</span>
<a name="line-228"></a><span class='hs-comment'>-- MULTIPATTERN COMPATIBLE SUBSTITUTIONS</span>
<a name="line-229"></a>
<a name="line-230"></a><a name="specials"></a><span class='hs-definition'>specials</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePattern</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Pat</span><span class='hs-keyglyph'>]</span>
<a name="line-231"></a><span class='hs-definition'>specials</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>f</span> <span class='hs-varop'>.</span> <span class='hs-varid'>parse</span>
<a name="line-232"></a>    <span class='hs-keyword'>where</span>
<a name="line-233"></a>        <span class='hs-varid'>f</span> <span class='hs-conid'>Lit</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-234"></a>        <span class='hs-varid'>f</span> <span class='hs-conid'>Star</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Star</span><span class='hs-keyglyph'>]</span>
<a name="line-235"></a>        <span class='hs-varid'>f</span> <span class='hs-conid'>Skip</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Skip</span><span class='hs-keyglyph'>]</span>
<a name="line-236"></a>        <span class='hs-varid'>f</span> <span class='hs-conid'>Skip1</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Skip</span><span class='hs-keyglyph'>]</span>
<a name="line-237"></a>        <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>Stars</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>xs</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>replicate</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>xs</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-conid'>Star</span>
<a name="line-238"></a>
<a name="line-239"></a><a name="simple"></a><span class='hs-comment'>-- | Is the pattern free from any * and //.</span>
<a name="line-240"></a><span class='hs-definition'>simple</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePattern</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-241"></a><span class='hs-definition'>simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>null</span> <span class='hs-varop'>.</span> <span class='hs-varid'>specials</span>
<a name="line-242"></a>
<a name="line-243"></a><a name="compatible"></a><span class='hs-comment'>-- | Do they have the same * and // counts in the same order</span>
<a name="line-244"></a><span class='hs-definition'>compatible</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePattern</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-245"></a><span class='hs-definition'>compatible</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-246"></a><span class='hs-definition'>compatible</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>==</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>specials</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>specials</span><span class='hs-layout'>)</span> <span class='hs-varid'>xs</span>
<a name="line-247"></a>
<a name="line-248"></a><a name="extract"></a><span class='hs-comment'>-- | Extract the items that match the wildcards. The pair must match with '?=='.</span>
<a name="line-249"></a><span class='hs-definition'>extract</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePattern</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-250"></a><span class='hs-definition'>extract</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>pat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parse</span> <span class='hs-varid'>p</span> <span class='hs-keyword'>in</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-251"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>match</span> <span class='hs-varid'>pat</span> <span class='hs-layout'>(</span><span class='hs-varid'>split</span> <span class='hs-varid'>isPathSeparator</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-252"></a>        <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>p</span> <span class='hs-varop'>?==</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>err</span> <span class='hs-varop'>$</span> <span class='hs-str'>"extract with "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>p</span> <span class='hs-varop'>++</span> <span class='hs-str'>" and "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>x</span>
<a name="line-253"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>error</span> <span class='hs-varop'>$</span> <span class='hs-str'>"Pattern "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>p</span> <span class='hs-varop'>++</span> <span class='hs-str'>" does not match "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>x</span> <span class='hs-varop'>++</span> <span class='hs-str'>", when trying to extract the FilePattern matches"</span>
<a name="line-254"></a>        <span class='hs-varid'>ms</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ms</span>
<a name="line-255"></a>
<a name="line-256"></a>
<a name="line-257"></a><a name="substitute"></a><span class='hs-comment'>-- | Given the result of 'extract', substitute it back in to a 'compatible' pattern.</span>
<a name="line-258"></a><span class='hs-comment'>--</span>
<a name="line-259"></a><span class='hs-comment'>-- &gt; p '?==' x ==&gt; substitute (extract p x) p == x</span>
<a name="line-260"></a><span class='hs-definition'>substitute</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePattern</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>
<a name="line-261"></a><span class='hs-definition'>substitute</span> <span class='hs-varid'>oms</span> <span class='hs-varid'>oxs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>intercalate</span> <span class='hs-str'>"/"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>concat</span> <span class='hs-varop'>$</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>f</span> <span class='hs-varid'>oms</span> <span class='hs-layout'>(</span><span class='hs-varid'>parse</span> <span class='hs-varid'>oxs</span><span class='hs-layout'>)</span>
<a name="line-262"></a>    <span class='hs-keyword'>where</span>
<a name="line-263"></a>        <span class='hs-varid'>f</span> <span class='hs-varid'>ms</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lit</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>x</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-264"></a>        <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-conop'>:</span><span class='hs-varid'>ms</span><span class='hs-layout'>)</span> <span class='hs-conid'>Star</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>m</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-265"></a>        <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-conop'>:</span><span class='hs-varid'>ms</span><span class='hs-layout'>)</span> <span class='hs-conid'>Skip</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms</span><span class='hs-layout'>,</span> <span class='hs-varid'>split</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-266"></a>        <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-conop'>:</span><span class='hs-varid'>ms</span><span class='hs-layout'>)</span> <span class='hs-conid'>Skip1</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms</span><span class='hs-layout'>,</span> <span class='hs-varid'>split</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-267"></a>        <span class='hs-varid'>f</span> <span class='hs-varid'>ms</span> <span class='hs-layout'>(</span><span class='hs-conid'>Stars</span> <span class='hs-varid'>pre</span> <span class='hs-varid'>mid</span> <span class='hs-varid'>post</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms2</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>concat</span> <span class='hs-varop'>$</span> <span class='hs-varid'>pre</span> <span class='hs-conop'>:</span> <span class='hs-varid'>zipWith</span> <span class='hs-layout'>(</span><span class='hs-varop'>++</span><span class='hs-layout'>)</span> <span class='hs-varid'>ms1</span> <span class='hs-layout'>(</span><span class='hs-varid'>mid</span><span class='hs-varop'>++</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>post</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-268"></a>            <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms1</span><span class='hs-layout'>,</span><span class='hs-varid'>ms2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAt</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>mid</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>ms</span>
<a name="line-269"></a>        <span class='hs-varid'>f</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-varop'>$</span> <span class='hs-str'>"Substitution failed into pattern "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>oxs</span> <span class='hs-varop'>++</span> <span class='hs-str'>" with "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>oms</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-str'>" matches, namely "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>oms</span>
<a name="line-270"></a>
<a name="line-271"></a>        <span class='hs-varid'>split</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>linesBy</span> <span class='hs-layout'>(</span><span class='hs-varop'>==</span> <span class='hs-chr'>'/'</span><span class='hs-layout'>)</span>
<a name="line-272"></a>
<a name="line-273"></a>
<a name="line-274"></a><span class='hs-comment'>---------------------------------------------------------------------</span>
<a name="line-275"></a><span class='hs-comment'>-- EFFICIENT PATH WALKING</span>
<a name="line-276"></a>
<a name="line-277"></a><a name="Walk"></a><span class='hs-comment'>-- | Given a list of files, return a list of things I can match in this directory</span>
<a name="line-278"></a><a name="Walk"></a><span class='hs-comment'>--   plus a list of subdirectories and walks that apply to them.</span>
<a name="line-279"></a><a name="Walk"></a><span class='hs-comment'>--   Use WalkTo when the list can be predicted in advance</span>
<a name="line-280"></a><a name="Walk"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Walk</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Walk</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-layout'>,</span><span class='hs-conid'>Walk</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-281"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-conid'>WalkTo</span>            <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-layout'>,</span><span class='hs-conid'>Walk</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-282"></a>
<a name="line-283"></a><a name="walk"></a><span class='hs-definition'>walk</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePattern</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-conid'>Walk</span><span class='hs-layout'>)</span>
<a name="line-284"></a><span class='hs-definition'>walk</span> <span class='hs-varid'>ps</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ps2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>optimise</span> <span class='hs-varop'>.</span> <span class='hs-varid'>parse</span><span class='hs-layout'>)</span> <span class='hs-varid'>ps</span> <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isEmpty</span> <span class='hs-varid'>p</span> <span class='hs-varop'>||</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varop'>$</span> <span class='hs-varid'>match</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>""</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ps2</span><span class='hs-layout'>,</span> <span class='hs-varid'>f</span> <span class='hs-varid'>ps2</span><span class='hs-layout'>)</span>
<a name="line-285"></a>    <span class='hs-keyword'>where</span>
<a name="line-286"></a>        <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>nubOrd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span>
<a name="line-287"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isLit</span> <span class='hs-varid'>fin</span><span class='hs-layout'>,</span> <span class='hs-varid'>all</span> <span class='hs-layout'>(</span><span class='hs-varid'>isLit</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fst</span><span class='hs-layout'>)</span> <span class='hs-varid'>nxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WalkTo</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fromLit</span> <span class='hs-varid'>fin</span><span class='hs-layout'>,</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromLit</span> <span class='hs-varop'>***</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-varid'>nxt</span><span class='hs-layout'>)</span>
<a name="line-288"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Walk</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>xs</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-289"></a>                <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>finStar</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>xs</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varop'>`matchOne`</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-varid'>fin</span><span class='hs-layout'>)</span> <span class='hs-varid'>xs</span>
<a name="line-290"></a>                <span class='hs-layout'>,</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-varid'>f</span> <span class='hs-varid'>ys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xs</span><span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>b</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>matchOne</span> <span class='hs-varid'>a</span> <span class='hs-varid'>x</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-varop'>$</span> <span class='hs-varid'>null</span> <span class='hs-varid'>ys</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-291"></a>            <span class='hs-keyword'>where</span>
<a name="line-292"></a>                <span class='hs-varid'>finStar</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Star</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>fin</span>
<a name="line-293"></a>                <span class='hs-varid'>fin</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nubOrd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mapMaybe</span> <span class='hs-varid'>final</span> <span class='hs-varid'>ps</span>
<a name="line-294"></a>                <span class='hs-varid'>nxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>groupSort</span> <span class='hs-varop'>$</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>next</span> <span class='hs-varid'>ps</span>
<a name="line-295"></a>
<a name="line-296"></a>
<a name="line-297"></a><a name="next"></a><span class='hs-definition'>next</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Pat</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Pat</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Pat</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-298"></a><span class='hs-definition'>next</span> <span class='hs-layout'>(</span><span class='hs-conid'>Skip1</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Star</span><span class='hs-layout'>,</span><span class='hs-conid'>Skip</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-299"></a><span class='hs-definition'>next</span> <span class='hs-layout'>(</span><span class='hs-conid'>Skip</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Star</span><span class='hs-layout'>,</span><span class='hs-conid'>Skip</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>next</span> <span class='hs-varid'>xs</span>
<a name="line-300"></a><span class='hs-definition'>next</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varop'>$</span> <span class='hs-varid'>null</span> <span class='hs-varid'>xs</span><span class='hs-keyglyph'>]</span>
<a name="line-301"></a><span class='hs-definition'>next</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-302"></a>
<a name="line-303"></a><a name="final"></a><span class='hs-definition'>final</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Pat</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Pat</span>
<a name="line-304"></a><span class='hs-definition'>final</span> <span class='hs-layout'>(</span><span class='hs-conid'>Skip</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isEmpty</span> <span class='hs-varid'>xs</span> <span class='hs-keyword'>then</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>Star</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>final</span> <span class='hs-varid'>xs</span>
<a name="line-305"></a><span class='hs-definition'>final</span> <span class='hs-layout'>(</span><span class='hs-conid'>Skip1</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isEmpty</span> <span class='hs-varid'>xs</span> <span class='hs-keyword'>then</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>Star</span> <span class='hs-keyword'>else</span> <span class='hs-conid'>Nothing</span>
<a name="line-306"></a><span class='hs-definition'>final</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isEmpty</span> <span class='hs-varid'>xs</span> <span class='hs-keyword'>then</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>x</span> <span class='hs-keyword'>else</span> <span class='hs-conid'>Nothing</span>
<a name="line-307"></a><span class='hs-definition'>final</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-308"></a>
<a name="line-309"></a><a name="isEmpty"></a><span class='hs-definition'>isEmpty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-layout'>(</span><span class='hs-varop'>==</span> <span class='hs-conid'>Skip</span><span class='hs-layout'>)</span>
</pre></body>
</html>
