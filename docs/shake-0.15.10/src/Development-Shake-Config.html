<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/Development/Shake/Config.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE DeriveDataTypeable, GeneralizedNewtypeDeriving #-}</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-comment'>-- | A module for parsing and using config files in a Shake build system. Config files</span>
<a name="line-4"></a><span class='hs-comment'>--   consist of variable bindings, for example:</span>
<a name="line-5"></a><span class='hs-comment'>--</span>
<a name="line-6"></a><span class='hs-comment'>-- &gt; # This is my Config file</span>
<a name="line-7"></a><span class='hs-comment'>-- &gt; HEADERS_DIR = /path/to/dir</span>
<a name="line-8"></a><span class='hs-comment'>-- &gt; CFLAGS = -g -I${HEADERS_DIR}</span>
<a name="line-9"></a><span class='hs-comment'>-- &gt; CFLAGS = $CFLAGS -O2</span>
<a name="line-10"></a><span class='hs-comment'>-- &gt; include extra/file.cfg</span>
<a name="line-11"></a><span class='hs-comment'>--</span>
<a name="line-12"></a><span class='hs-comment'>--   This defines the variable @HEADERS_DIR@ (equal to @\/path\/to\/dir@), and</span>
<a name="line-13"></a><span class='hs-comment'>--   @CFLAGS@ (equal to @-g -I\/path\/to\/dir -O2@), and also includes the configuration</span>
<a name="line-14"></a><span class='hs-comment'>--   statements in the file @extra/file.cfg@. The full lexical syntax for configuration</span>
<a name="line-15"></a><span class='hs-comment'>--   files is defined here: &lt;https://ninja-build.org/manual.html#_lexical_syntax&gt;.</span>
<a name="line-16"></a><span class='hs-comment'>--</span>
<a name="line-17"></a><span class='hs-comment'>--   To use the configuration file either use 'readConfigFile' to parse the configuration file</span>
<a name="line-18"></a><span class='hs-comment'>--   and use the values directly, or 'usingConfigFile' and 'getConfig' to track the configuration</span>
<a name="line-19"></a><span class='hs-comment'>--   values, so they become build dependencies.</span>
<a name="line-20"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Development</span><span class='hs-varop'>.</span><span class='hs-conid'>Shake</span><span class='hs-varop'>.</span><span class='hs-conid'>Config</span><span class='hs-layout'>(</span>
<a name="line-21"></a>    <span class='hs-varid'>readConfigFile</span><span class='hs-layout'>,</span> <span class='hs-varid'>readConfigFileWithEnv</span><span class='hs-layout'>,</span>
<a name="line-22"></a>    <span class='hs-varid'>usingConfigFile</span><span class='hs-layout'>,</span> <span class='hs-varid'>usingConfig</span><span class='hs-layout'>,</span>
<a name="line-23"></a>    <span class='hs-varid'>getConfig</span><span class='hs-layout'>,</span> <span class='hs-varid'>getConfigKeys</span>
<a name="line-24"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-25"></a>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Development</span><span class='hs-varop'>.</span><span class='hs-conid'>Shake</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Development</span><span class='hs-varop'>.</span><span class='hs-conid'>Shake</span><span class='hs-varop'>.</span><span class='hs-conid'>Classes</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Development</span><span class='hs-varop'>.</span><span class='hs-conid'>Ninja</span><span class='hs-varop'>.</span><span class='hs-conid'>Parse</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Ninja</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Development</span><span class='hs-varop'>.</span><span class='hs-conid'>Ninja</span><span class='hs-varop'>.</span><span class='hs-conid'>Env</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Ninja</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>HashMap</span><span class='hs-varop'>.</span><span class='hs-conid'>Strict</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Map</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span><span class='hs-varop'>.</span><span class='hs-conid'>UTF8</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>UTF8</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Applicative</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Tuple</span><span class='hs-varop'>.</span><span class='hs-conid'>Extra</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Prelude</span>
<a name="line-36"></a>
<a name="line-37"></a>
<a name="line-38"></a><a name="readConfigFile"></a><span class='hs-comment'>-- | Read a config file, returning a list of the variables and their bindings.</span>
<a name="line-39"></a><span class='hs-comment'>--   Config files use the Ninja lexical syntax:</span>
<a name="line-40"></a><span class='hs-comment'>--   &lt;https://ninja-build.org/manual.html#_lexical_syntax&gt;</span>
<a name="line-41"></a><span class='hs-definition'>readConfigFile</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-conid'>HashMap</span> <span class='hs-conid'>String</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span>
<a name="line-42"></a><span class='hs-definition'>readConfigFile</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>readConfigFileWithEnv</span> <span class='hs-conid'>[]</span>
<a name="line-43"></a>
<a name="line-44"></a>
<a name="line-45"></a><a name="readConfigFileWithEnv"></a><span class='hs-comment'>-- | Read a config file with an initial environment, returning a list of the variables and their bindings.</span>
<a name="line-46"></a><span class='hs-comment'>--   Config files use the Ninja lexical syntax:</span>
<a name="line-47"></a><span class='hs-comment'>--   &lt;https://ninja-build.org/manual.html#_lexical_syntax&gt;</span>
<a name="line-48"></a><span class='hs-definition'>readConfigFileWithEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-conid'>HashMap</span> <span class='hs-conid'>String</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span>
<a name="line-49"></a><span class='hs-definition'>readConfigFileWithEnv</span> <span class='hs-varid'>vars</span> <span class='hs-varid'>file</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-50"></a>    <span class='hs-varid'>env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>Ninja</span><span class='hs-varop'>.</span><span class='hs-varid'>newEnv</span>
<a name="line-51"></a>    <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>uncurry</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ninja</span><span class='hs-varop'>.</span><span class='hs-varid'>addEnv</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>UTF8</span><span class='hs-varop'>.</span><span class='hs-varid'>fromString</span> <span class='hs-varop'>***</span> <span class='hs-conid'>UTF8</span><span class='hs-varop'>.</span><span class='hs-varid'>fromString</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>vars</span>
<a name="line-52"></a>    <span class='hs-conid'>Ninja</span><span class='hs-varop'>.</span><span class='hs-varid'>parse</span> <span class='hs-varid'>file</span> <span class='hs-varid'>env</span>
<a name="line-53"></a>    <span class='hs-varid'>mp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>Ninja</span><span class='hs-varop'>.</span><span class='hs-varid'>fromEnv</span> <span class='hs-varid'>env</span>
<a name="line-54"></a>    <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>fromList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-conid'>UTF8</span><span class='hs-varop'>.</span><span class='hs-varid'>toString</span> <span class='hs-varop'>***</span> <span class='hs-conid'>UTF8</span><span class='hs-varop'>.</span><span class='hs-varid'>toString</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>toList</span> <span class='hs-varid'>mp</span>
<a name="line-55"></a>
<a name="line-56"></a>
<a name="line-57"></a><a name="Config"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>Config</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Config</span> <span class='hs-conid'>String</span> <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Show</span><span class='hs-layout'>,</span><span class='hs-conid'>Typeable</span><span class='hs-layout'>,</span><span class='hs-conid'>Eq</span><span class='hs-layout'>,</span><span class='hs-conid'>Hashable</span><span class='hs-layout'>,</span><span class='hs-conid'>Binary</span><span class='hs-layout'>,</span><span class='hs-conid'>NFData</span><span class='hs-layout'>)</span>
<a name="line-58"></a>
<a name="line-59"></a><a name="ConfigKeys"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>ConfigKeys</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ConfigKeys</span> <span class='hs-conid'>()</span> <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Show</span><span class='hs-layout'>,</span><span class='hs-conid'>Typeable</span><span class='hs-layout'>,</span><span class='hs-conid'>Eq</span><span class='hs-layout'>,</span><span class='hs-conid'>Hashable</span><span class='hs-layout'>,</span><span class='hs-conid'>Binary</span><span class='hs-layout'>,</span><span class='hs-conid'>NFData</span><span class='hs-layout'>)</span>
<a name="line-60"></a>
<a name="line-61"></a>
<a name="line-62"></a><a name="usingConfigFile"></a><span class='hs-comment'>-- | Specify the file to use with 'getConfig'.</span>
<a name="line-63"></a><span class='hs-definition'>usingConfigFile</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Rules</span> <span class='hs-conid'>()</span>
<a name="line-64"></a><span class='hs-definition'>usingConfigFile</span> <span class='hs-varid'>file</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-65"></a>    <span class='hs-varid'>mp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newCache</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-conid'>()</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-66"></a>        <span class='hs-varid'>need</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>file</span><span class='hs-keyglyph'>]</span>
<a name="line-67"></a>        <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>readConfigFile</span> <span class='hs-varid'>file</span>
<a name="line-68"></a>    <span class='hs-varid'>addOracle</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-conid'>Config</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-varid'>x</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>mp</span> <span class='hs-conid'>()</span>
<a name="line-69"></a>    <span class='hs-varid'>addOracle</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-conid'>ConfigKeys</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>sort</span> <span class='hs-varop'>.</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>keys</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>mp</span> <span class='hs-conid'>()</span>
<a name="line-70"></a>    <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-71"></a>
<a name="line-72"></a>
<a name="line-73"></a><a name="usingConfig"></a><span class='hs-comment'>-- | Specify the values to use with 'getConfig', generally prefer</span>
<a name="line-74"></a><span class='hs-comment'>--   'usingConfigFile' unless you also need access to the values</span>
<a name="line-75"></a><span class='hs-comment'>--   of variables outside 'Action'.</span>
<a name="line-76"></a><span class='hs-definition'>usingConfig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-conid'>HashMap</span> <span class='hs-conid'>String</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Rules</span> <span class='hs-conid'>()</span>
<a name="line-77"></a><span class='hs-definition'>usingConfig</span> <span class='hs-varid'>mp</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-78"></a>    <span class='hs-varid'>addOracle</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-conid'>Config</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-varid'>x</span> <span class='hs-varid'>mp</span>
<a name="line-79"></a>    <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-80"></a>
<a name="line-81"></a>
<a name="line-82"></a><a name="getConfig"></a><span class='hs-comment'>-- | Obtain the value of a configuration variable, returns 'Nothing' to indicate the variable</span>
<a name="line-83"></a><span class='hs-comment'>--   has no binding. Any build system using 'getConfig' /must/ call either 'usingConfigFile'</span>
<a name="line-84"></a><span class='hs-comment'>--   or 'usingConfig'. The 'getConfig' function will introduce a dependency on the configuration</span>
<a name="line-85"></a><span class='hs-comment'>--   variable (but not the whole configuration file), and if the configuration variable changes, the rule will be rerun.</span>
<a name="line-86"></a><span class='hs-comment'>--   As an example:</span>
<a name="line-87"></a><span class='hs-comment'>--</span>
<a name="line-88"></a><span class='hs-comment'>-- @</span>
<a name="line-89"></a><span class='hs-comment'>-- 'usingConfigFile' \"myconfiguration.cfg\"</span>
<a name="line-90"></a><span class='hs-comment'>-- \"*.o\" '%&gt;' \\out -&gt; do</span>
<a name="line-91"></a><span class='hs-comment'>--     cflags &lt;- 'getConfig' \"CFLAGS\"</span>
<a name="line-92"></a><span class='hs-comment'>--     'cmd' \"gcc\" [out '-&lt;.&gt;' \"c\"] (fromMaybe \"\" cflags)</span>
<a name="line-93"></a><span class='hs-comment'>-- @</span>
<a name="line-94"></a><span class='hs-definition'>getConfig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Action</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span>
<a name="line-95"></a><span class='hs-definition'>getConfig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>askOracle</span> <span class='hs-varop'>.</span> <span class='hs-conid'>Config</span>
<a name="line-96"></a>
<a name="line-97"></a>
<a name="line-98"></a><a name="getConfigKeys"></a><span class='hs-comment'>-- | Obtain the configuration keys.</span>
<a name="line-99"></a><span class='hs-comment'>--   Any build system using 'getConfigKeys' /must/ call either 'usingConfigFile' or 'usingConfig'.</span>
<a name="line-100"></a><span class='hs-comment'>--   The 'getConfigKeys' function will introduce a dependency on the configuration keys</span>
<a name="line-101"></a><span class='hs-comment'>--   (but not the whole configuration file), and if the configuration keys change, the rule will be rerun.</span>
<a name="line-102"></a><span class='hs-comment'>--   Usually use as part of an action.</span>
<a name="line-103"></a><span class='hs-comment'>--   As an example:</span>
<a name="line-104"></a><span class='hs-comment'>--</span>
<a name="line-105"></a><span class='hs-comment'>-- @</span>
<a name="line-106"></a><span class='hs-comment'>-- 'usingConfigFile' \"myconfiguration.cfg\"</span>
<a name="line-107"></a><span class='hs-comment'>-- 'action' $ need =&lt;&lt; getConfigKeys</span>
<a name="line-108"></a><span class='hs-comment'>-- @</span>
<a name="line-109"></a><span class='hs-definition'>getConfigKeys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Action</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-110"></a><span class='hs-definition'>getConfigKeys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>askOracle</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ConfigKeys</span> <span class='hs-conid'>()</span>
</pre></body>
</html>
